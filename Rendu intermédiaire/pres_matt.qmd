---
title: "Modelling the desensitization in patients awaiting transplantation"
author: "BREUZA Léonie, MAZET Matthias, OKADO Kento, VIGNAUD Enzo"
date: 12/19/2024
date-format: "DD MMMM YYYY"
format:
  revealjs: 
    slide-number: true
    chalkboard: 
      buttons: false
    preview-links: auto
    logo: images/Logo_UGA.png
    css: assets/style.css
    toc: true
    toc-depth: 4
    resources: images
    footer: "Tutored Project M1 SDS"
    header-includes: |
      <script src="assets/custom.js" type="application/javascript"></script>
    slide-level: 4
    responsive: TRUE
    center: TRUE
    width: 150%
    height: 150%
lang: "en"
---

Rajouter "number-sections: true" dans l'en-tête pour éviter d'avoir à modifier les numéros des sections à chaque fois ? 

### B) Data description

```{r, echo = FALSE, warning = FALSE, message = FALSE}
# Librairies
library(knitr)
library(kableExtra)

# Données de nettoyage
source("../nettoyage_matthias.R")
    # pb de path réglé normalement


# Netoyage général
# data_net <- read.csv("../donnees_corrigees_CINEDESIM.csv")
    # pas bon car pas mis en factor
```


- Longitudinal data: 20 samples for each of the 10 patients.
  
- Statistical unit: a patient.

- Outcome variable:\  `MFI Classe I`\  and\  `MFI Classe II`

```{r}
mfi <- as.data.frame(data[, c("C1.MFI", "C2.MFI")])

mins <- c()
med <- c()
moy <- c()
maxs <- c()

for (i in 1:length(mfi)) {
  mins[i] <- min(mfi[, i], na.rm = TRUE)
  med[i] <- median(mfi[, i], na.rm = TRUE)
  moy[i] <- mean(mfi[, i], na.rm = TRUE)
  maxs[i] <- max(mfi[, i], na.rm = TRUE)
}

tab_mfi <- data.frame(Variables = c("MFI Classe I", "MFI Classe II"), Min = mins, Median = med, Mean = moy, Max = maxs)
kable(tab_mfi, align = "r", digits = 2)
```




### B) Data description

- 8 selected covariates :\  `Time`,\  `Durée de la séance (min)`,\  `Volume plasma traité`,\  `Poids (kg)`,\  `Taille (cm)`,\  `Sexe`,\  `Grossesses`,\  `Greffe antérieure`.

::: {.content-container style="display: flex; justify-content: space-between; align-items: flex-start;"}

<div style="flex: 0.45; text-align: left;">

```{r}
var_quanti <- as.data.frame(data[, c("Durée de la seance (min )", "Volume plasma traite", 
                                     "Poids (kg)", "Taille (cm)")])

mins <- c()
med <- c()
moy <- c()
maxs <- c()

for (i in 1:length(var_quanti)) {
  mins[i] <- min(var_quanti[, i], na.rm = TRUE)
  med[i] <- median(var_quanti[, i], na.rm = TRUE)
  moy[i] <- mean(var_quanti[, i], na.rm = TRUE)
  maxs[i] <- max(var_quanti[, i], na.rm = TRUE)
}

tab_quanti <- data.frame(Variables = names(var_quanti), Min = mins, Median = med, Mean = round(moy, 1), Max = maxs)
tab_quanti <- kable(tab_quanti, align = "r")
kable_styling(tab_quanti, font_size = 25)
```


</div> <div style="flex: 0.45; text-align: left;">

```{r}
tab_sexe <- kable(table(data$Sexe) / 20, col.names = c("Sexe", "Number"), align = "r")
kable_styling(tab_sexe, font_size = 25)
```

</div>
:::

::: {.content-container style="display: flex; justify-content: space-between; margin-top: 20px;"}

<div style="flex: 0.45; text-align: left;">

```{r}
tab_greffe <- kable(table(data$`Greffe anterieur`) / 20, col.names = c("Previous transplants", "Number"), align = "r")
kable_styling(tab_greffe, font_size = 25)
```


</div> <div style="flex: 0.45; text-align: left;">

```{r}
tab_gross <- kable(table(data$Grossesses) / 20, col.names = c("Pregnancies", "Number"), align = "r")
kable_styling(tab_gross, font_size = 25)
```

</div>
:::



#### 2. Descriptive statistics per patient and session

```{r, echo = FALSE, warning = FALSE, message = FALSE}
library(ggplot2)
library(ggpubr)

# Données de nettoyage
source("../nettoyage_matthias.R")
```


```{r, echo = FALSE, warning = FALSE, message = FALSE}
# Compter les patients < 3000 MFI à chaque séance
data$C1.MFI_bool <- NA
for (i in 1:nrow(data)) {
  if (is.na(data$C1.MFI[i]) == FALSE) {
    if ((data$C1.MFI[i] < 3000) == TRUE) {
      data$C1.MFI_bool[i] <- 1
    } else {
      data$C1.MFI_bool[i] <- 0
    }
  }
}
tab_1 <- as.data.frame(table(data$C1.MFI_bool, data$Time)[2, ])
colnames(tab_1) <- c("Number")

data$C2.MFI_bool <- NA
for (i in 1:nrow(data)) {
  if (is.na(data$C2.MFI[i]) == FALSE) {
    if ((data$C2.MFI[i] < 3000) == TRUE) {
      data$C2.MFI_bool[i] <- 1
    } else {
      data$C2.MFI_bool[i] <- 0
    }
  }
}
tab_2 <- as.data.frame(table(data$C2.MFI_bool, data$Time)[2, ])
colnames(tab_2) <- c("Number")
```


```{r, echo = FALSE, warning = FALSE, message = FALSE, out.width = "75%"}
# Combiner les graphes
bp1 <- ggplot(data, aes(x = `Nom du Batch`, y = `Volume plasma traite`)) + 
  geom_boxplot(na.rm = TRUE, fill = "lightgrey") +
  labs(x = "Patients", y = "Plasma treated volume") + 
  scale_x_discrete(labels = seq_along(unique(data$`Nom du Batch`))) +
  theme_minimal() +   
  theme(axis.title.x = element_text(color = "blue3", face = "bold", size = 8), 
        axis.title.y = element_text(color = "blue3", face = "bold", size = 8),)

bp2 <- ggplot(data, aes(x = `Nom du Batch`, y = `Durée de la seance (min )`)) + 
  geom_boxplot(na.rm = TRUE, fill = "lightgrey") + 
  labs(x = "Patients", y = "Session duration (min)") + 
  scale_x_discrete(labels = seq_along(unique(data$`Nom du Batch`))) +
  theme_minimal() +   
  theme(axis.title.x = element_text(color = "blue3", face = "bold", size = 8), 
        axis.title.y = element_text(color = "blue3", face = "bold", size = 8),)


bp3 <- ggplot(tab_1, aes(x = 1:20, y = Number)) +
  geom_bar(stat = "identity", fill = ifelse(1:20 %% 2 == 1, "lightcoral", "springgreen3")) +
  labs(x = "Session", y = "Number of patients < 3000 Class I MFI") +
  scale_y_continuous(limits = c(0, 10)) +
  geom_vline(xintercept = 10.5, linetype = 2, color = "red3", size = 1) +
  theme_minimal() +   
  theme(axis.title.x = element_text(color = "blue3", face = "bold", size = 8), 
        axis.title.y = element_text(color = "blue3", face = "bold", size = 8),)

bp4 <- ggplot(tab_2, aes(x = 1:20, y = Number)) +
  geom_bar(stat = "identity", fill = ifelse(1:20 %% 2 == 1, "lightcoral", "springgreen3")) +
  labs(x = "Session", y = "Number of patients < 3000 Class II MFI", ) +
  scale_y_continuous(limits = c(0, 10)) +
  geom_vline(xintercept = 10.5, linetype = 2, color = "red3", size = 1) +
  theme_minimal() +   
  theme(axis.title.x = element_text(color = "blue3", face = "bold", size = 8), 
        axis.title.y = element_text(color = "blue3", face = "bold", size = 8),)

plot_f <- ggarrange(bp1, bp2, bp3, bp4, ncol = 2, nrow = 2)
# plot_f

# Pour sauvegarder en image 
ggsave("stat_desc.png", plot = plot_f, width = 8, height = 5, path ="../Rendu intermédiaire/images")
```

<p align="center" display="table-cell" vertical-align="middle"> <img src="/images/stat_desc.png"  height="800" width="1500"> </p>



### B) Possible scenarios

::: {.content-container style="display: flex; justify-content: space-around; align-items: flex-start;"}

<div style="flex: 1;">
  
```{r}
library(knitr)
library(reshape2)
library(dplyr)
library(shadowtext)

# Matrice des risques
# Paramètres de la matrice
n <- 5
p <- 5
mat <- matrix(NA, nrow = n, ncol = p)
rownames(mat) <- c("5", "4", "3", "2", "1")
colnames(mat) <- c("1", "2", "3", "4", "5")


# Transformer la matrice pour ggplot
sur_mat <- melt(mat)
colnames(sur_mat) <- c("Likelihood", "Consequence", "Impact")
sur_mat <- mutate(sur_mat, Likelihood = as.numeric(as.character(Likelihood)),
                  Consequence = as.numeric(as.character(Consequence)),
                  Impact = Consequence + Likelihood)


# Couleurs pour la matrice
couleurs <- c("green", "green2", "yellow2", "orange", "red3")


# Données des risques
tags <- c("Non functional study", "Legal issues (plagiarism)", "Team conflicts", "Files' loss", "Response fail", 
          "Wrong files' versions", "Missing students", "Delayed schedule", "Changing in backers' needs")
x <- c(5, 4, 4.5, 3.5, 5, 2.5, 2, 3.5, 5)
y <- c(1, 1, 1.5, 2, 2.5, 2.5, 4.5, 3.5, 5)
data <- data.frame("Tags" = tags, "Consequence" = x, "Likelihood" = y)
data <- mutate(data, Impact = Consequence + Likelihood, Numbers = 1:nrow(data))


# Création de la matrice des risques
mat_risk <- ggplot(sur_mat, aes(x = Consequence, y = Likelihood, fill = Impact)) + 
  geom_tile(color = "white") +
  scale_fill_gradientn(colours = couleurs, limits = c(0, 10), guide = "none") + 
  scale_x_continuous(breaks = 1:5, expand = c(0, 0)) + 
  scale_y_continuous(breaks = 1:5, expand = c(0, 0)) + 
  coord_fixed() +
  theme_minimal() +
  ggtitle("Risk Matrix") +
  labs(x = "Consequence", y = "Likelihood") +
  geom_point(data = data, aes(x = Consequence, y = Likelihood), color = "black", size = 3, pch = 18) +
  geom_shadowtext(data = data, aes(x = Consequence, y = Likelihood, label = Numbers),
                  hjust = 0.5, vjust = 1.5, color = "black", fontface = "bold", 
                  size = 7, bg.colour = "white", bg.r = 0.1) +
  theme(axis.title.x = element_text(face = "bold", size = 15), 
        axis.title.y = element_text(face = "bold", size = 15),
        title = element_text(face = "bold", size = 15))
mat_risk
```


</div> <div style="flex: 1; text-align: center;">
```{r, warning=FALSE}
# Légende associée à côté
library(kableExtra)

risks <- data[, c(5, 1)]
tab1 <- kable(risks, align = "r")
kable_styling(tab1, font_size = 25)
```

</div>
:::

::: {.content-container style="margin-top: 20px; text-align: center;"}

```{r}
# Tableau (corrigé) en dessous
scenar <- data.frame(c("Best", "Worst", "Most likely"),
                     c("✓", "✓", "✓"),
                     c("✓", "✓", "✓"),
                     c("✓", "✗", "✓"),
                     c("✓", "✗", "?"),
                     c("✓", "✓", "✓"),
                     c("✓", "✓", "✓"),
                     c("✓", "✗", "✗"))

colnames(scenar) <- c("Scenarios", "Data management", "Model choice", "Model optimisation", 
                      "Protocol optimisation", "Needs charter", "App model", "App development")

tab_scenar <- kable(scenar, align = "c")
kable_styling(tab_scenar, font_size = 25)
```

:::